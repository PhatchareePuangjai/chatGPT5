name: DAST Security Scan (All Versions)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  zap_scan:
    name: Scan ${{ matrix.version }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    strategy:
      fail-fast: false # ถ้าเวอร์ชันหนึ่งพัง ให้เวอร์ชันอื่นรันต่อ
      matrix:
        include:
          - version: 'v.3'
            path: 'src/versions/v.3/online-shop-inventory'
            port: '5173'
            
          - version: 'v.4'
            path: 'src/versions/v.4/shopping-cart-app'
            port: '5173'

          - version: 'v.5'
            path: 'src/versions/v.5/promo-shop-plug-and-play'
            port: '8080'

          - version: 'v.6'
            path: 'src/versions/v.6/inventory-system'
            port: '3000' # ใช้ port 3000 สำหรับ Web ตาม Env variables ด้านล่าง

          - version: 'v.7'
            path: 'src/versions/v.7/shopping-cart-bundle'
            port: '8080'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # (เฉพาะ v.6) สร้างไฟล์ .env เพราะ docker-compose.yml ของ v.6 มีการอ้างถึง env_file: .env
      - name: Create .env file for v.6
        if: matrix.version == 'v.6'
        run: |
          echo "Creating .env file for v.6"
          cat <<EOF > src/versions/v.6/inventory-system/.env
          DB_USER=test
          DB_PASSWORD=test
          DB_NAME=testdb
          DB_HOST=db
          DB_PORT=5432
          DB_PORT_EXTERNAL=5432
          API_PORT=4000
          WEB_PORT=3000
          LOW_STOCK_THRESHOLD=10
          VITE_API_BASE=http://localhost:4000
          EOF

      - name: Start Application (${{ matrix.version }})
        working-directory: ./${{ matrix.path }}
        run: |
          # ส่งผ่าน environment variables ปัจจุบันเข้าไปใน docker-compose
          docker compose up -d --build
          echo "Waiting for application to initialize..."
          sleep 60 # รอ 60 วินาทีเพื่อให้แน่ใจว่า DB และ App พร้อมทำงานจริงๆ

      - name: Prepare Artifact Name
        run: |
          VERSION="${{ matrix.version }}"
          # แทนที่จุด . ด้วยขีด - เพื่อความปลอดภัยของชื่อ artifact
          SAFE_VERSION=${VERSION//./-}
          echo "ARTIFACT_NAME=zap-report-$SAFE_VERSION" >> $GITHUB_ENV

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:${{ matrix.port }}'
          fail_action: false # เปลี่ยนเป็น true ถ้าอยากให้ build fail เมื่อเจอ issue
          artifact_name: ${{ env.ARTIFACT_NAME }}
          # cmd_options: '-a' # Uncomment หากต้องการรวม AJAX Spider (สแกนลึกขึ้นแต่ช้าลง)

      - name: Stop Application
        if: always()
        working-directory: ./${{ matrix.path }}
        run: docker compose down
