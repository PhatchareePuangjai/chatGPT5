name: DAST Security Scan (All Versions)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  zap_scan:
    name: Scan ${{ matrix.version }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # เปลี่ยนชื่อจาก v.3 เป็น v3 เพื่อเลี่ยงปัญหาชื่อ Artifact
          - version: 'v3'
            path: 'src/versions/v.3/online-shop-inventory'
            port: '5173'
            
          - version: 'v4'
            path: 'src/versions/v.4/shopping-cart-app'
            port: '5173'

          - version: 'v5'
            path: 'src/versions/v.5/promo-shop-plug-and-play'
            port: '8080'

          - version: 'v6'
            path: 'src/versions/v.6/inventory-system'
            port: '3000'

          - version: 'v7'
            path: 'src/versions/v.7/shopping-cart-bundle'
            port: '8080'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create .env file for v.6
        if: matrix.version == 'v6'
        run: |
          cat <<EOF > src/versions/v.6/inventory-system/.env
          DB_USER=test
          DB_PASSWORD=test
          DB_NAME=testdb
          DB_HOST=db
          DB_PORT=5432
          DB_PORT_EXTERNAL=5432
          API_PORT=4000
          WEB_PORT=3000
          LOW_STOCK_THRESHOLD=10
          VITE_API_BASE=http://localhost:4000
          EOF

      - name: Start Application (${{ matrix.version }})
        # แก้ไข: ระบุ path ตรงๆ จาก matrix โดยไม่ต้องมี ./ นำหน้า
        working-directory: ${{ matrix.path }}
        run: |
          docker compose up -d --build
          echo "Waiting for application to initialize..."
          sleep 60 

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:${{ matrix.port }}'
          fail_action: false
          # แก้ไข: ใช้ชื่อจาก matrix.version ที่เราเอาจุดออกแล้ว
          artifact_name: 'zap-report-${{ matrix.version }}'

      - name: Stop Application
        if: always()
        working-directory: ${{ matrix.path }}
        run: docker compose down