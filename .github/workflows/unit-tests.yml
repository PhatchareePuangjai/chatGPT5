name: Unit Tests

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/versions/v.3/**'
      - 'src/versions/v.4/**'
      - 'src/versions/v.5/**'
      - 'src/versions/v.6/**'
      - 'src/versions/v.7/**'
      - 'src/versions/v.8/**'
      - 'src/versions/v.9/**'
      - 'src/versions/v.10/**'
      - 'src/versions/v.11/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'src/versions/v.3/**'
      - 'src/versions/v.4/**'
      - 'src/versions/v.5/**'
      - 'src/versions/v.6/**'
      - 'src/versions/v.7/**'
      - 'src/versions/v.8/**'
      - 'src/versions/v.9/**'
      - 'src/versions/v.10/**'
      - 'src/versions/v.11/**'
  workflow_dispatch:

jobs:
  test:
    name: Test ${{ matrix.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: v.3
            path: src/versions/v.3/online-shop-inventory/backend
          - version: v.4
            path: src/versions/v.4/shopping-cart-app/backend
          - version: v.5
            path: src/versions/v.5/promo-shop-plug-and-play/backend
          - version: v.6
            path: src/versions/v.6/inventory-system/backend
          - version: v.7
            path: src/versions/v.7/shopping-cart/backend
          - version: v.8
            path: src/versions/v.8/promotions-discounts-system/backend
          - version: v.9
            path: src/versions/v.9/backend
          - version: v.10
            path: src/versions/v.10/shopping-cart-app/backend
          - version: v.11
            path: src/versions/v.11/promotions-app/backend

    steps:
      - uses: actions/checkout@v4

      # ใช้ paths-filter เพื่อเช็คว่ามีการแก้ไขในโฟลเดอร์ของ version นั้นๆ หรือไม่
      # แต่ถ้าเป็น workflow_dispatch ให้รันทุก version
      - uses: dorny/paths-filter@v2
        id: changes
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            src:
              - '${{ matrix.path }}/**'

      # กำหนดว่าจะรันหรือไม่ (true ถ้าเป็น workflow_dispatch หรือมี changes)
      - name: Determine if should run
        id: should_run
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.changes.outputs.src }}" == "true" ]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.should_run.outputs.run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.path }}/package-lock.json

      # Setup PostgreSQL สำหรับ version ที่ต้องการ database
      - name: Setup PostgreSQL
        if: steps.should_run.outputs.run == 'true' && (matrix.version == 'v.3' || matrix.version == 'v.6' || matrix.version == 'v.9')
        uses: actions/setup-postgres@v1
        with:
          postgres-version: '15'
          postgres-user: ${{ matrix.version == 'v.9' && 'inventory' || 'postgres' }}
          postgres-password: ${{ matrix.version == 'v.9' && 'inventory' || 'postgres' }}
          postgres-db: ${{ matrix.version == 'v.9' && 'inventory' || (matrix.version == 'v.6' && 'inventory' || 'shopdb') }}

      - name: Check if package.json exists
        if: steps.should_run.outputs.run == 'true'
        id: check_package
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f "package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ package.json not found for ${{ matrix.version }}"
          fi

      - name: Install Dependencies
        if: steps.should_run.outputs.run == 'true' && steps.check_package.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        run: npm ci

      # Run database migrations สำหรับ version ที่ต้องการ
      - name: Run Database Migrations
        if: steps.should_run.outputs.run == 'true' && steps.check_package.outputs.exists == 'true' && (matrix.version == 'v.3' || matrix.version == 'v.6' || matrix.version == 'v.9')
        working-directory: ${{ matrix.path }}
        env:
          DATABASE_URL: ${{ matrix.version == 'v.9' && 'postgresql://inventory:inventory@localhost:5432/inventory' || (matrix.version == 'v.6' && 'postgres://postgres:postgres@localhost:5432/inventory' || 'postgres://postgres:postgres@localhost:5432/shopdb') }}
        run: |
          if [ -f "scripts/run-migrations.js" ]; then
            npm run migrate || echo "⚠️ Migration script not found or failed"
          elif [ -f "db/migrate.js" ]; then
            npm run db:migrate || echo "⚠️ Migration script not found or failed"
          else
            echo "ℹ️ No migration script found for ${{ matrix.version }}"
          fi

      - name: Check if test script exists
        if: steps.should_run.outputs.run == 'true' && steps.check_package.outputs.exists == 'true'
        id: check_test
        working-directory: ${{ matrix.path }}
        run: |
          if grep -q '"test"' package.json; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ No test script found in package.json for ${{ matrix.version }}"
          fi

      - name: Run Tests
        if: steps.should_run.outputs.run == 'true' && steps.check_package.outputs.exists == 'true' && steps.check_test.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        continue-on-error: true
        env:
          DATABASE_URL: ${{ matrix.version == 'v.9' && 'postgresql://inventory:inventory@localhost:5432/inventory' || (matrix.version == 'v.6' && 'postgres://postgres:postgres@localhost:5432/inventory' || (matrix.version == 'v.3' && 'postgres://postgres:postgres@localhost:5432/shopdb' || '')) }}
          NODE_ENV: test
        run: npm test
